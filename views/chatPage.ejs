<!-- Sidebar -->
<div class="sidebar">
    <input class="search-bar" type="text" placeholder="Search...">
    <div class="chat-list">
        <% userChats.forEach(chat => { %>
            <div class="chat-item" onclick="location.href='/chat/<%= chat._id %>'">
                <div class="avatar"></div>
                <div class="chat-info">
                    <!-- Display other participant's username -->
                    <p class="chat-name">
                        <% if (chat.sender._id.toString() === user._id.toString()) { %>
                            <%= chat.receiver.username %>
                        <% } else { %>
                            <%= chat.sender.username %>
                        <% } %>
                    </p>
                    <p class="chat-preview"><%= chat.lastMessage %></p>
                </div>
                <p class="chat-time"><%= new Date(chat.lastUpdated).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></p>
            </div>
        <% }); %>
    </div>
    <button onclick="toggleModal()">Start New Chat</button>
</div>

<!-- Chat Area -->
<div class="chat-area">
    <% if (selectedChat) { %>
        <div class="chat-header">
            <div class="header-avatar"></div>
            <div class="header-info">
                <p class="header-username">
                    <% if (selectedChat.sender._id.toString() === user._id.toString()) { %>
                        <%= selectedChat.receiver.username %>
                    <% } else { %>
                        <%= selectedChat.sender.username %>
                    <% } %>
                </p>
                <p class="header-status">Online</p>
            </div>
            <form action="/chat/toggleMeme/<%= selectedChat._id %>" method="POST">
                <label>
                    <input type="checkbox" name="memeRecommendation" <%= selectedChat.memeRecommendation ? 'checked' : '' %> onchange="this.form.submit()">
                    Meme Recommendations
                </label>
            </form>
        </div>

        <div class="messages-container">
            <% selectedChat.messages.forEach(message => { %>
                <div class="message <%= message.senderId.toString() === user._id.toString() ? 'sent' : 'received' %>">
                    <% if (message.messageType === 'text') { %>
                        <p><%= message.message %></p>
                    <% } else if (message.messageType === 'image' || message.messageType === 'meme') { %>
                        <img src="<%= message.mediaUrl %>" alt="media" />
                    <% } %>
                    <small><%= new Date(message.timestamp).toLocaleString() %></small>
                </div>
            <% }); %>
        </div>

        <div class="input-container">
            <form action="/chat/<%= selectedChat._id %>/send" method="POST">
                <input class="message-input" type="text" name="message" placeholder="Type a message..." required>
                <button class="send-button" type="submit">Send</button>
            </form>
        </div>
    <% } else { %>
        <div class="no-chat-selected">
            <p>Select a chat to start messaging.</p>
        </div>
    <% } %>
</div>

<!-- New Chat Modal -->
<div class="modal" id="newChatModal">
    <div class="modal-content">
        <form action="/chat/new" method="POST">
            <input type="text" name="recipientUsername" placeholder="Enter username..." required>
            <button type="submit">Start Chat</button>
        </form>
        <button onclick="toggleModal()">Cancel</button>
    </div>
</div>

<script>
    function toggleModal() {
        const modal = document.getElementById('newChatModal');
        modal.classList.toggle('active');
    }
</script>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #181818;
        color: #ffffff;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
    }

    /* Sidebar styles */
    .sidebar {
        width: 25%;
        background-color: #222222;
        display: flex;
        flex-direction: column;
        padding: 10px;
    }

    .search-bar {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        border: none;
        border-radius: 5px;
        background-color: #333333;
        color: white;
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
    }

    .chat-item {
        display: flex;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #333333;
    }

    .chat-item:hover {
        background-color: #2a2a2a;
    }

    .avatar {
        width: 40px;
        height: 40px;
        background-color: #555555;
        border-radius: 50%;
        margin-right: 10px;
    }

    .chat-info {
        flex: 1;
    }

    .chat-name {
        font-weight: bold;
    }

    .chat-preview {
        font-size: 0.9em;
        color: #aaaaaa;
    }

    .chat-time {
        font-size: 0.8em;
        color: #888888;
    }

    /* Chat Area styles */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #222222;
        border-bottom: 1px solid #333333;
    }

    .header-avatar {
        width: 50px;
        height: 50px;
        background-color: #555555;
        border-radius: 50%;
    }

    .header-info {
        margin-left: 10px;
    }

    .header-username {
        font-weight: bold;
    }

    .header-status {
        font-size: 0.8em;
        color: #aaaaaa;
    }

    /* Chat messages styles */
    .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .message {
        max-width: 60%;
        padding: 10px;
        border-radius: 10px;
    }

    .sent {
        align-self: flex-end;
        background-color: #dcf8c6;
        color: #000;
    }

    .received {
        align-self: flex-start;
        background-color: #f1f0f0;
        color: #000;
    }

    /* Input area styles */
    .input-container {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #222222;
        border-top: 1px solid #333333;
    }

    .message-input {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        background-color: #333333;
        color: white;
        margin-right: 10px;
    }

    .send-button {
        background-color: #555555;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        color: white;
        cursor: pointer;
    }

    /* New Chat Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background-color: #222222;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
    }

    .modal input, .modal button {
        width: 100%;
        margin-bottom: 10px;
    }
</style>
